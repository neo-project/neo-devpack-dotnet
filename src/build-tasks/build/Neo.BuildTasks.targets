<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" TreatAsLocalProperty="NeoBuildTasksFolder;NeoBuildTasksAssembly">

  <PropertyGroup>
    <NeoBuildTasksFolder Condition=" '$(MSBuildRuntimeType)' == 'Core' ">netstandard2.0</NeoBuildTasksFolder>
    <NeoBuildTasksFolder Condition=" '$(MSBuildRuntimeType)' != 'Core' ">net472</NeoBuildTasksFolder>
    <NeoBuildTasksAssembly>$(MSBuildThisFileDirectory)..\tasks\$(NeoBuildTasksFolder)\neo-build-tasks.dll</NeoBuildTasksAssembly>
  </PropertyGroup>

  <UsingTask AssemblyFile="$(NeoBuildTasksAssembly)" TaskName="Neo.BuildTasks.NeoContractInterface"/>
  <UsingTask AssemblyFile="$(NeoBuildTasksAssembly)" TaskName="Neo.BuildTasks.NeoCsc"/>
  <UsingTask AssemblyFile="$(NeoBuildTasksAssembly)" TaskName="Neo.BuildTasks.NeoExpressBatch"/>

  <Target Name="BeforeExecuteNeoCsc" BeforeTargets="ExecuteNeoCsc" Condition="'$(NeoContractName)'!=''">
    <PropertyGroup>
      <NeoCscOutputFolder Condition="'$(NeoContractOutput)'==''">$([MSBuild]::NormalizePath($(MSBuildProjectDirectory), 'bin\sc'))</NeoCscOutputFolder>
      <NeoCscOutputFolder Condition="'$(NeoContractOutput)'!=''">$(NeoContractOutput)</NeoCscOutputFolder>

      <NeoCscContractPath>$([MSBuild]::NormalizePath($(NeoCscOutputFolder), '$(NeoContractName).nef'))</NeoCscContractPath>
      <NeoCscManifestPath>$([MSBuild]::NormalizePath($(NeoCscOutputFolder), '$(NeoContractName).manifest.json'))</NeoCscManifestPath>
      <NeoCscDebugInfoPath>$([MSBuild]::NormalizePath($(NeoCscOutputFolder), '$(NeoContractName).nefdbgnfo'))</NeoCscDebugInfoPath>
      <NeoCscAssemblyPath>$([MSBuild]::NormalizePath($(NeoCscOutputFolder), '$(NeoContractName).asm'))</NeoCscAssemblyPath>

      <NeoCscOptimize>true</NeoCscOptimize>
      <NeoCscOptimize Condition="'$(Configuration)'=='Debug'">false</NeoCscOptimize>
    </PropertyGroup>

    <ItemGroup>
      <NeoCscOutput Include="$(NeoCscContractPath)" />
      <NeoCscOutput Include="$(NeoCscManifestPath)" />
      <NeoCscOutput Include="$(NeoCscDebugInfoPath)" Condition="'$(DebugSymbols)'=='true'" />
      <NeoCscOutput Include="$(NeoCscAssemblyPath)" Condition="'$(NeoContractAssembly)'=='true'"/>
    </ItemGroup>
  </Target>

  <Target Name="ExecuteNeoCsc" AfterTargets="Compile" Condition="'$(NeoContractName)'!=''"
    Inputs="$(MSBuildProjectFullPath);@(Compile);" Outputs="@(NeoCscOutput)">

    <NeoCsc 
      Files="$(MSBuildProjectFullPath)"
      Output="$(NeoContractOutput)"
      ContractName="$(NeoContractName)"
      Assembly="$(NeoContractAssembly)"
      Debug="$(DebugSymbols)"
      Inline="$(Optimize)"
      Optimize="$(Optimize)"
      WorkingDirectory="$(MSBuildProjectDirectory)"/>
  </Target>

  <Target Name="AfterExecuteNeoCsc" AfterTargets="ExecuteNeoCsc" Condition="'$(NeoContractName)'!=''">
    <Message Importance="High" Text="$(NeoContractName) -&gt; $(NeoCscContractPath)" />
  </Target>

  <Target Name="BeforeExecuteNeoExpressBatch" BeforeTargets="ExecuteNeoExpressBatch" Condition="'$(NeoExpressBatchFile)'!=''">
    <PropertyGroup>
      <NeoExpressTouchFile>$([MSBuild]::NormalizePath($(IntermediateOutputPath), '$(NeoExpressBatchFile).neoxp.touch'))</NeoExpressTouchFile>
      <NeoExpressNormalizedBatchFile>$([MSBuild]::NormalizePath($(MSBuildProjectDirectory), $(NeoExpressBatchFile)))</NeoExpressNormalizedBatchFile>
    </PropertyGroup>
  </Target>

  <Target Name="ExecuteNeoExpressBatch" AfterTargets="ExecuteNeoCsc" Condition="'$(NeoExpressBatchFile)'!=''"
    Inputs="@(NeoCscOutput);$(NeoExpressBatchFile);$(NeoExpressTouchFile)" Outputs="$(NeoExpressTouchFile)">

    <PropertyGroup>
      <NeoExpressNormalizedBatchFile>$([MSBuild]::NormalizePath($(MSBuildProjectDirectory), $(NeoExpressBatchFile)))</NeoExpressNormalizedBatchFile>
      <NeoExpressBatchReset>true</NeoExpressBatchReset>
      <NeoExpressBatchReset Condition="'(NeoExpressBatchNoReset)'=='true'">false</NeoExpressBatchReset>
    </PropertyGroup>

    <NeoExpressBatch 
      BatchFile="$(NeoExpressNormalizedBatchFile)" 
      InputFile="$(NeoExpressBatchInputFile)"
      Reset="$(NeoExpressBatchReset)"
      Checkpoint="$(NeoExpressBatchCheckpoint)"
      Trace="$(NeoExpressBatchTrace)"
      StackTrace="$(NeoExpressBatchStackTrace)"
      WorkingDirectory="$(MSBuildProjectDirectory)" />
    <Touch Files="$(NeoExpressTouchFile)" AlwaysCreate="true" />
    <Message Importance="High" Text="NeoExpress Batch -> $(NeoExpressNormalizedBatchFile)" />
  </Target>

  <Target Name="GetNeoContractInfo" Returns="@(NeoContractInfo)" >
    <ItemGroup Condition="'$(NeoContractName)'!=''" >
      <NeoContractInfo Include="$(NeoContractName)">
        <NefPath>$(NeoCscContractPath)</NefPath>
        <ManifestPath>$(NeoCscManifestPath)</ManifestPath>
      </NeoContractInfo>
    </ItemGroup>
  </Target>

  <Target Name="GenerateNeoContractInterface" BeforeTargets="ResolveProjectReferences" Condition="'@(NeoContractReference)'!=''">

    <ItemGroup>
      <ProjectReference Include="@(NeoContractReference)">
        <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
      </ProjectReference>
    </ItemGroup>

    <MSBuild Projects="@(NeoContractReference)" Targets="GetNeoContractInfo">
      <Output TaskParameter="TargetOutputs" ItemName="NeoContractInfo" />
    </MSBuild>

    <ItemGroup>
      <NeoContractManifest Include="@(NeoContractInfo)" >
        <ManifestFile>@(NeoContractInfo->Metadata('ManifestPath'))</ManifestFile>
        <OutputFile>$(IntermediateOutputPath)@(NeoContractInfo).contract-interface.cs</OutputFile>
      </NeoContractManifest>
    </ItemGroup>

    <NeoContractInterface
      ManifestFile="@(NeoContractManifest->Metadata('ManifestFile'))"
      OutputFile="$(IntermediateOutputPath)@(NeoContractInfo).contract-interface.cs"
      RootNamespace="$(RootNamespace)"/>

    <ItemGroup>
      <Compile Include="@(NeoContractManifest->Metadata('OutputFile'))" />
    </ItemGroup>

    <Message Importance="High" Text="NeoContractInterface @(NeoContractManifest) -> @(NeoContractManifest->Metadata('OutputFile'))" />

  </Target>

</Project>